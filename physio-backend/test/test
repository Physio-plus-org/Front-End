<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    xmlns:app="http://schemas.android.com/apk/res-auto">

    <!-- Top Bar -->
    <RelativeLayout
        android:id="@+id/topBarLayout"
        android:layout_width="match_parent"
        android:layout_height="80dp">


        <!-- backButton -->
        <ImageView
            android:id="@+id/goback"
            android:layout_width="50dp"
            android:layout_height="50dp"
            android:layout_marginTop="25dp"
            android:layout_marginStart="10dp"
            android:contentDescription="@string/goback"
            android:src="@drawable/goback"
            android:text="@string/backbutton"
            android:title=""
            android:layout_centerVertical="true"
            app:showAsAction="ifRoom">

        </ImageView>



        <!-- Logo -->

        <ImageView
            android:id="@+id/physiologo"
            android:layout_width="47dp"
            android:layout_height="49dp"
            android:layout_centerVertical="true"
            android:layout_marginStart="140dp"
            android:contentDescription="@string/physiologo"
            android:iconTint="@color/PrimaryGreen"
            android:src="@drawable/physiologo"
            android:title=""
            app:showAsAction="ifRoom">

        </ImageView>


        <!-- Text Logo -->
        <TextView
            android:id="@+id/text"
            android:layout_width="wrap_content"
            android:layout_height="50dp"


            android:layout_centerVertical="true"
            android:layout_toEndOf="@id/physiologo"
            android:contentDescription="@string/physiotext"
            android:iconTint="@color/PrimaryGreen"
            android:src="@drawable/physiotext"
            android:text="@string/physio"
            android:textSize="30sp"
            android:title=""
            app:showAsAction="ifRoom">

        </TextView>

        <!-- Plus sign-->

        <ImageView
            android:id="@+id/physSign"
            android:layout_width="50dp"
            android:layout_height="49dp"
            android:layout_marginTop="5dp"
            android:layout_toEndOf="@id/text"
            android:paddingEnd="34dp"
            android:paddingStart="0dp"
            android:contentDescription="@string/plusSign"
            android:iconTint="@color/PrimaryGreen"
            android:src="@drawable/baseline_add_24"
            android:title=""
            app:showAsAction="ifRoom">

        </ImageView>

        <!-- Profile Icon -->
        <ImageView
            android:id="@+id/profile"
            android:layout_width="50dp"
            android:layout_height="50dp"
            android:layout_toEndOf="@+id/text"
            android:layout_centerHorizontal="true"
            android:layout_alignParentTop="true"
            android:layout_alignParentEnd="true"
            android:contentDescription="@string/profile"
            android:src="@drawable/baseline_person_24"
            android:title=""
            android:layout_centerVertical="true"
            android:layout_marginTop="15dp"
            android:layout_marginStart="45dp"
            app:showAsAction="ifRoom"  >
    </ImageView>


    </RelativeLayout>

    <!-- Content -->
    <RelativeLayout
        android:id="@+id/contentLayout"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_below="@id/topBarLayout">

        <TextView

            android:id="@+id/day"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_centerHorizontal="true"
            android:text="Αιτήματα" >

        </TextView>

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="550dp"
            android:layout_marginHorizontal="40dp"
            android:layout_marginVertical="20dp"
            android:layout_marginStart="40dp"
            android:layout_marginTop="30dp"
            android:layout_marginEnd="40dp"
            android:layout_marginBottom="30dp"
            android:background="@drawable/roundedshape"
            android:orientation="vertical">

            <TextView
                android:id="@+id/orologioProgramma"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_margin="20dp"
                android:layout_marginStart="20dp"
                android:layout_marginTop="20dp"
                android:layout_marginEnd="20dp"
                android:layout_marginBottom="20dp"
                android:text="@string/orologioProgramma">

            </TextView>


            <TextView
                android:id="@+id/nineAm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:layout_marginStart="7dp"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_9_00">


            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/tenAm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_10_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/elevenAm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_11_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"

                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/twelveAm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_12_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/onePm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_13_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/twoPm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_14_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/threePm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_15_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/fourPm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_16_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/fivePm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_17_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/sixPm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_18_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/sevenPm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_19_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:scaleType="center"
                android:id="@+id/eightPm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_20_00">

            </TextView>

            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/ninePm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_21_00">

            </TextView>


            <View
                android:layout_width="25dp"
                android:layout_height="2dp"
                android:layout_marginStart="17dp"
                android:background="#c0c0c0" />

            <TextView
                android:id="@+id/tenPm"
                android:layout_width="300dp"
                android:layout_height="25dp"
                android:layout_margin="7dp"
                android:clickable="true"
                android:onClick="onTimeSlotClicked"
                android:background="@drawable/longroundedshape"
                android:paddingStart="10dp"
                android:paddingEnd="0dp"
                android:text="@string/_22_00">

            </TextView>


        </LinearLayout>

    </RelativeLayout>

    <!-- Footer -->
    <RelativeLayout
        android:background="@color/AccentOrange"
        android:id="@+id/footerLayout"
        android:layout_width="match_parent"
        android:layout_height="70dp"
        android:layout_alignParentBottom="true">

        <ImageView
            android:id="@+id/calendar"
            android:layout_width="200dp"
            android:layout_height="60dp"
            android:layout_alignParentStart="true"
            android:layout_centerVertical="true"
            android:layout_marginStart="5dp"
            android:layout_marginTop="40dp"
            android:layout_marginEnd="40dp"
            android:layout_marginBottom="40dp"
            android:background="@drawable/footerroundedshape"
            android:contentDescription="@string/goback"
            android:src="@drawable/baseline_calendar_month_24"
            android:text="@string/calendarButton"
            android:title=""
            app:showAsAction="ifRoom"></ImageView>


        <ImageView
            android:id="@+id/euro"
            android:layout_width="230dp"
            android:layout_height="60dp"
            android:layout_centerVertical="true"
            android:layout_marginStart="208dp"
            android:layout_marginTop="40dp"
            android:layout_marginEnd="5dp"
            android:layout_marginBottom="40dp"
            android:background="@drawable/footerroundedshape"
            android:contentDescription="@string/goback"
            android:src="@drawable/baseline_euro_24"
            android:text="@string/calendarButton"
            android:title=""
            app:showAsAction="ifRoom"></ImageView>



    </RelativeLayout>




</RelativeLayout>




package com.example.helloworld;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;


import android.graphics.Color;
import android.os.Bundle;
import android.text.Spannable;
import android.text.SpannableString;
import android.text.style.ForegroundColorSpan;
import android.util.Log;
import android.view.View;
import android.view.ViewGroup;
import android.view.WindowManager;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.PopupWindow;
import android.widget.TextView;
import com.example.helloworld.utils.HttpRequestHelper;
import java.io.IOException;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.List;


public class MainActivity extends AppCompatActivity {

    private static final String ACCEPTED_URL = "http://192.168.1.7/physio-backend/move_to_accepted.php";
    private static final String TESTCON_URL = "http://192.168.1.7/physio-backend/verify_connection.php";



    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        TextView highlightText= findViewById(R.id.RequestAppoint);
        TextView bubbleText = findViewById(R.id.bubbleText);
        ImageView calendarTopBar = findViewById(R.id.calendarTopBar);

        calendarTopBar.setOnClickListener((View.OnClickListener) v -> showAppointmentDropdown(calendarTopBar));

        getNotification(bubbleText);

        setHighlightedText(highlightText);

        testConnection();
    }

    private void showAppointmentDropdown(ImageView calendarTopBar) {
        // Create a new PopupWindow
        PopupWindow popupWindow = new PopupWindow(MainActivity.this);

        // Set the content view of the popup window to your custom dropdown layout
        View dropdownView = getLayoutInflater().inflate(R.layout.dropdown_layout, null);
        popupWindow.setContentView(dropdownView);

        // Set the width and height of the popup window
        popupWindow.setWidth(WindowManager.LayoutParams.WRAP_CONTENT);
        popupWindow.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);


        // Get the actual appointment data from your backend or data source
        List<String> appointmentData = getAppointmentData();

        // Populate the appointment items dynamically
        for (int i = 0; i < appointmentData.size(); i++) {
                // Add additional TextViews programmatically if there are more than 3 appointments
                TextView textView = new TextView(MainActivity.this);
                textView.setLayoutParams(new ViewGroup.LayoutParams(
                        ViewGroup.LayoutParams.WRAP_CONTENT,
                        ViewGroup.LayoutParams.WRAP_CONTENT));
                textView.setText(appointmentData.get(i));
                ((LinearLayout) dropdownView).addView(textView);
        }
        popupWindow.showAsDropDown(calendarTopBar);
    }

    private List<String> getAppointmentData() {

        ArrayList<String> appointments = new ArrayList<>();
        return appointments;
    }

    private void getNotification(TextView bubbleText) {
        int numberOfProposedAppointments = 5; // Replace with your actual data

        if (numberOfProposedAppointments > 0) {
            // Display the bubble and set the text
            bubbleText.setVisibility(View.VISIBLE);
            bubbleText.setText(String.valueOf(numberOfProposedAppointments));
        } else {
            // Hide the bubble if there are no proposed appointments
            bubbleText.setVisibility(View.GONE);
        }
    }

    private void setHighlightedText(TextView textView) {
        String fullText = "Αιτήματα Ραντεβού";
        String highlightedText = "Ραντεβού";

        SpannableString spannableString = new SpannableString(fullText);
        int startIndex = fullText.indexOf(highlightedText);
        int endIndex = startIndex + highlightedText.length();

        ForegroundColorSpan foregroundColorSpan = new ForegroundColorSpan(Color.GREEN);
        spannableString.setSpan(foregroundColorSpan, startIndex, endIndex, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);

        textView.setText(spannableString);
    }


    public void onTimeSlotClicked(View view) {
        try {
            String time = ((TextView) view).getText().toString().trim();

           String timeslot = simplifytime(time);
            showAppointmentDialog(timeslot, view);
        } catch (Exception e) {
            Log.e("Error", "An error occurred: " + e.getMessage());
        }
    }

    private String simplifytime(String time) {
        String firstchar = time.substring(0,1);
        String secondchar= "";
        if( time.length() == 5 ){
            secondchar = time.substring(1,2);
        }

        return firstchar + secondchar;
    }


    private void showAppointmentDialog(String timeslot, final View view) {
        try {
            AlertDialog.Builder builder = new AlertDialog.Builder(this);
            builder.setTitle("Απόφαση Ραντεβού");
            builder.setIcon(R.drawable.baseline_access_time_24);
            builder.setMessage("Θέλετε να πραγματοποιήσετε το ραντεβού σας στις " + timeslot + ";");
            builder.setPositiveButton("Ναι", (dialog, which) -> {
                try {
                    view.setBackgroundResource(R.color.PrimaryGreen);
                    acceptAppointment(timeslot);
                } catch (Exception e) {
                    Log.e("Error", "An error occurred while pressing the accept button: " + e.getMessage());
                }
            });
            builder.setNegativeButton("Άκυρο", (dialog, which) -> {
                try {
                    dialog.dismiss();
                } catch (Exception e) {
                    Log.e("Error", "An error occurred while pressing the declione button: " + e.getMessage());
                }
            });
            builder.show();

        }catch (Exception e){
            Log.e("Error", "An error occurred while creating the builder dialog box: " + e.getMessage());
        }
    }



    private void acceptAppointment(String timeslot) {
        try {
            String url = ACCEPTED_URL + "?time=" + URLEncoder.encode(timeslot, "UTF-8");
            String response = HttpRequestHelper.sendGetRequest(url);

            if (response.equals("success")) {

                Log.d("AcceptAppointment", "Appointment accepted successfully");
            } else {
                // Handle failure case
                Log.d("AcceptAppointment", "Failed to accept appointment");
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void testConnection() {
        try {
            String response = HttpRequestHelper.sendGetRequest(TESTCON_URL);
            if (response.equals("success")) {
                Log.d("Connection", "Successfully connected to the database");
                // Handle the successful connection
            } else {
                Log.d("Connection", "Failed to connect to the database");
                // Handle the failed connection
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }



}


